<header>
  <h1>{{ title }}</h1>
</header>

<section class='item-contents'>
  {{ rendermarkup(tr(intro)) }}
</section>

{{
hextint = function (r, g, b)
  if not g then r, g, b = table.unpack(r) end
  return string.format('#%02x%02x%02x', r, g, b)
end

normaliselum = function (val, r, g, b)
  if g then r = {r, g, b}
  else r = {r[1], r[2], r[3]} end
  -- https://stackoverflow.com/q/596216
  for i = 1, 3 do
    local v = r[i] / 255
    if v <= 0.04045 then v = v / 12.92
    else v = ((v + 0.055) / 1.055) ^ 2.4 end
    r[i] = v
  end
  local y = r[1] * 0.1216 + r[2] * 0.7152 + r[3] * 0.0722

  local function invgamma(v)
    if v <= 0.0031308 then v = v * 12.92
    else v = 1.055 * (v ^ (1/2.4)) - 0.055 end
    return math.floor(math.min(1, v) * 255 + 0.5)
  end
  local weight = val / y * 0.8 + 0.2
  return
    invgamma(r[1] * weight),
    invgamma(r[2] * weight),
    invgamma(r[3] * weight)
end
}}

{{@ list in {friendlist, webringlist} }}
<div role='separator' class='windy'></div>

{{
  native, foreign = {}, {}
  for _, i in ipairs(list) do
    local found = false
    for _, sitelang in ipairs(i.langs) do
      if sitelang == lang then
        found = true; break
      end
    end
    if found then native[#native + 1] = i
    else foreign[#foreign + 1] = i end
  end
}}

{{@ sublist in {native, foreign} }}
<div class='friend-item-container'>
{{@ sublist }}
{{ hash = basehash(name .. link) }}
<a class='friend-item'
  style="
    color: {{ hextint(normaliselum(0.1, tint)) }};
    border-color: {{ hextint(tint) }};
    {{@ bgimg }}background-image: url({{ file(bgimg, 'items/' .. name) }});{{@ end }}
  "
  href='{{ link }}'
>
<div class='text'>
  <h1><span class='title'>{{ title }}</span><!--
    -->{{@ pending }}<span class='icon' title='{{ pendingtext }}'>â€»</span>{{@ end }}<!--
    --></h1>
  {{@ author }}<p>{{ author }}</p>{{@ end }}
  <p class='pastel-underline pastel-underline-{{ hash }}'>{{ link:match('^https?://([^/]+)') }}</p>
  {{@ #langs > 1 or langs[1] ~= lang }}
  <p class='langs'>{{*
    local curlangnames = {}
    for _, l in ipairs(langs) do
      table.insert(curlangnames,
        l == lang and 1 or (#curlangnames + 1), tr(langnames[l]))
    end
    return table.concat(curlangnames, '/')
  }}</p>
  {{@ end }}
</div>
</a>
<style>
.pastel-underline-{{ hash }}::after {
  background: {{ hextint(normaliselum(0.4, tint)) }};
}
</style>
{{@ end }}
{{@ end }}
</div>
{{@ end }}

<style>
.friend-item-container {
  max-inline-size: 40em;
  margin: auto;
}
.friend-item {
  display: block;
  text-decoration: none;
  margin-block: 1.5em;
  min-block-size: 7.5em;
  margin-inline: 1.5em;
  padding-inline: 2em;
  background-size: contain;
  background-repeat: no-repeat;
  background-position: 85% 50%;
}
.friend-item:nth-of-type(2n+1) {
  border-inline-start: 0.12em solid black;
}
.friend-item:nth-of-type(2n) {
  text-align: right;
  border-inline-end: 0.12em solid black;
  background-position: 15% 50%; /* Spell out fully for NetSurf compatibility */
}
@media (max-width: 115vh), (max-width: 48rem) {
  .friend-item {
    margin-inline: 0.5em;
    padding-inline: 1.5em;
  }
  .friend-item:nth-of-type(2n+1) {
    background-position: 90% 50%;
  }
  .friend-item:nth-of-type(2n) {
    background-position: 10% 50%;
  }
}
.friend-item .text {
  padding-block: 0.5em;
}
@supports (transform: translateY(-50%)) {
  .friend-item .text {
    padding: 0;
    position: relative;
    inset-block-start: 3.6em;
    transform: translateY(-50%);
  }
}
.friend-item h1,
.friend-item p {
  margin-block: 0.5em;
}
.friend-item h1 {
  font-size: 1.333rem;
  display: flex;
  flex-direction: row;
}
.friend-item:nth-of-type(2n) h1 {
  flex-direction: row-reverse;
}
.friend-item h1 > span {
  display: inline-block;
}
.friend-item h1 > span.title {
  overflow-x: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.friend-item:nth-of-type(2n+1) h1 > span.icon {
  margin-inline-start: 0.25em;
}
.friend-item:nth-of-type(2n) h1 > span.icon {
  margin-inline-end: 0.25em;
}
.friend-item p.pastel-underline {
  display: inline-block;
  margin-block-start: 0;
  block-size: 1.5em;
}
.friend-item p.pastel-underline::after {
  content: '';
  display: block;
  block-size: 0.12em;
  margin-block-start: -0.12em;
  margin-block-end: -0.12em;
  border-radius: 1em;
  opacity: 0.2;
}
.friend-item p.langs {
  /* float: inline-end; */
  position: absolute;
  inset-block-end: 0;
  /* inset-inline-end: 0; */
  border: 1px solid;
  border-radius: 0.4em;
  padding-inline: 0.5em;
}
.friend-item:nth-of-type(2n+1) p.langs {
  float: right;
  right: 0;
}
.friend-item:nth-of-type(2n) p.langs {
  float: left;
  left: 0;
}
</style>

<div role='separator' class='windy'></div>

<span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;CapacitiveSensor.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;rh_mp3.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define REGION_KICK     1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define REGION_TOP      0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define REGION_SQUEEZE  0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define REGION_FLUFF    0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define REGION_PICK     0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define REGION_SLIDE    0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define INSPECT_SENSORS 0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PLAY_MP3        !INSPECT_SENSORS
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">sign</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Returns whether x is outside of the range [a, b), which may wrap around the maximum value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">outside</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">b</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">^</span> <span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">^</span> <span class="n">sign</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="n">T</span> <span class="n">t</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">inline</span> <span class="kt">int</span> <span class="nf">cmp_long</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span> <span class="o">-</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">FungiCapSensor</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">volatile</span> <span class="n">IO_REG_TYPE</span> <span class="o">*</span><span class="n">sReg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">IO_REG_TYPE</span> <span class="n">sBit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">volatile</span> <span class="n">IO_REG_TYPE</span> <span class="o">*</span><span class="n">rReg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">IO_REG_TYPE</span> <span class="n">rBit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">SENSOR_BASE_UNINIT_TAG</span> <span class="o">=</span> <span class="mh">0x3FFFFFF0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">SENSOR_TIMEOUT</span> <span class="o">=</span> <span class="mh">0x3FFFFFFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">N_SAMPLES_PER_OUTPUT</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">N_HIST</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">N_SAMPLES_TOTAL</span> <span class="o">=</span> <span class="n">N_HIST</span> <span class="o">*</span> <span class="n">N_SAMPLES_PER_OUTPUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">histSamples</span><span class="p">[</span><span class="n">N_SAMPLES_TOTAL</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">FungiCapSensor</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">sendPin</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">recvPin</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pinMode</span><span class="p">(</span><span class="n">sendPin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pinMode</span><span class="p">(</span><span class="n">recvPin</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">base</span> <span class="o">=</span> <span class="n">SENSOR_BASE_UNINIT_TAG</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sReg</span> <span class="o">=</span> <span class="n">PIN_TO_BASEREG</span><span class="p">(</span><span class="n">sendPin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sBit</span> <span class="o">=</span> <span class="n">PIN_TO_BITMASK</span><span class="p">(</span><span class="n">sendPin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rReg</span> <span class="o">=</span> <span class="n">PIN_TO_BASEREG</span><span class="p">(</span><span class="n">recvPin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rBit</span> <span class="o">=</span> <span class="n">PIN_TO_BITMASK</span><span class="p">(</span><span class="n">recvPin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">sampleRaw</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t0</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">noInterrupts</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIRECT_WRITE_LOW</span><span class="p">(</span><span class="n">sReg</span><span class="p">,</span> <span class="n">sBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIRECT_MODE_INPUT</span><span class="p">(</span><span class="n">rReg</span><span class="p">,</span> <span class="n">rBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIRECT_MODE_OUTPUT</span><span class="p">(</span><span class="n">rReg</span><span class="p">,</span> <span class="n">rBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIRECT_WRITE_LOW</span><span class="p">(</span><span class="n">rReg</span><span class="p">,</span> <span class="n">rBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIRECT_MODE_INPUT</span><span class="p">(</span><span class="n">rReg</span><span class="p">,</span> <span class="n">rBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t0</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">tm</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="mi">2000000</span><span class="p">;</span>  <span class="c1">// May overflow and wrap around
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DIRECT_WRITE_HIGH</span><span class="p">(</span><span class="n">sReg</span><span class="p">,</span> <span class="n">sBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">interrupts</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">DIRECT_READ</span><span class="p">(</span><span class="n">rReg</span><span class="p">,</span> <span class="n">rBit</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">T</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">outside</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span> <span class="k">return</span> <span class="n">SENSOR_TIMEOUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span> <span class="o">=</span> <span class="n">micros</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">noInterrupts</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIRECT_WRITE_HIGH</span><span class="p">(</span><span class="n">rReg</span><span class="p">,</span> <span class="n">rBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIRECT_MODE_OUTPUT</span><span class="p">(</span><span class="n">rReg</span><span class="p">,</span> <span class="n">rBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIRECT_WRITE_HIGH</span><span class="p">(</span><span class="n">rReg</span><span class="p">,</span> <span class="n">rBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIRECT_MODE_INPUT</span><span class="p">(</span><span class="n">rReg</span><span class="p">,</span> <span class="n">rBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t0</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">tm</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="mi">2000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIRECT_WRITE_LOW</span><span class="p">(</span><span class="n">sReg</span><span class="p">,</span> <span class="n">sBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">interrupts</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">DIRECT_READ</span><span class="p">(</span><span class="n">rReg</span><span class="p">,</span> <span class="n">rBit</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">T</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">outside</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span> <span class="k">return</span> <span class="n">SENSOR_TIMEOUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">t2</span> <span class="o">=</span> <span class="n">micros</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">populateCalibration</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_SAMPLES_TOTAL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">histSamples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampleRaw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">sampleCalibrated</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* memmove(
</span></span></span><span class="line"><span class="cl"><span class="cm">      histSamples,
</span></span></span><span class="line"><span class="cl"><span class="cm">      histSamples + sizeof(histSamples[0]) * N_SAMPLES_PER_OUTPUT,
</span></span></span><span class="line"><span class="cl"><span class="cm">      sizeof(histSamples[0]) * (N_HIST - 1) * N_SAMPLES_PER_OUTPUT
</span></span></span><span class="line"><span class="cl"><span class="cm">    ); */</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_SAMPLES_TOTAL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">N_SAMPLES_PER_OUTPUT</span> <span class="o">&lt;</span> <span class="n">N_SAMPLES_TOTAL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">histSamples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">histSamples</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">N_SAMPLES_PER_OUTPUT</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">histSamples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampleRaw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">a</span><span class="p">[</span><span class="n">N_SAMPLES_TOTAL</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">memcpy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">histSamples</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">qsort</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">N_SAMPLES_TOTAL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="n">cmp_long</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int</span> <span class="n">I_START</span> <span class="o">=</span> <span class="n">N_SAMPLES_TOTAL</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int</span> <span class="n">I_END</span> <span class="o">=</span> <span class="n">N_SAMPLES_TOTAL</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">I_START</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">SENSOR_TIMEOUT</span><span class="p">)</span> <span class="n">result</span> <span class="o">=</span> <span class="n">SENSOR_TIMEOUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Normalize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="n">SENSOR_TIMEOUT</span><span class="p">)</span> <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">/</span> <span class="p">(</span><span class="n">I_END</span> <span class="o">-</span> <span class="n">I_START</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">base</span> <span class="o">-</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">base</span> <span class="o">!=</span> <span class="n">SENSOR_BASE_UNINIT_TAG</span><span class="p">)</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">base</span> <span class="o">-=</span> <span class="n">delta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FungiCapSensor</span> <span class="n">sensor</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if REGION_SQUEEZE || REGION_FLUFF || REGION_PICK || REGION_SLIDE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">FungiCapSensor</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#if REGION_SQUEEZE || REGION_FLUFF || REGION_PICK || REGION_SLIDE || REGION_TOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">FungiCapSensor</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="n">FungiCapSensor</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">FungiCapSensor</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="n">FungiCapSensor</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="n">FungiCapSensor</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="n">FungiCapSensor</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="n">FungiCapSensor</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="n">FungiCapSensor</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="n">FungiCapSensor</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">N_SENSORS</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">sensor</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="n">sensor</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lastBaseInc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">template</span> <span class="o">&lt;</span><span class="n">size_t</span> <span class="n">N</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">A</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">B</span><span class="p">,</span> <span class="kt">long</span> <span class="n">ThrAbsl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ThrRel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Interval</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="nc">SensorHistoryTrigger</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">history</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">SensorHistoryTrigger</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">wait</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">shift</span><span class="p">(</span><span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">history</span><span class="p">[</span><span class="n">ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">N</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">wait</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Overall trend
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">int</span> <span class="n">upCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">history</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="n">upCount</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">upCount</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">a</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">memcpy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">qsort</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="n">cmp_long</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">A</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ThrAbsl</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">A</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ThrRel</span> <span class="o">/</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="n">wait</span> <span class="o">=</span> <span class="n">Interval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">wait</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">template</span> <span class="o">&lt;</span><span class="kt">long</span> <span class="n">ThrAbslFirst</span><span class="p">,</span> <span class="kt">long</span> <span class="n">ThrAbsl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">CountThr</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="nc">SensorContinuousTrigger</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">SensorContinuousTrigger</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">shift</span><span class="p">(</span><span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">state</span> <span class="o">?</span> <span class="nl">ThrAbsl</span> <span class="p">:</span> <span class="n">ThrAbslFirst</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">Capacity</span><span class="p">)</span> <span class="n">count</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">count</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">last</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">CountThr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">^</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="n">count</span> <span class="o">=</span> <span class="n">Capacity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">state</span> <span class="o">?</span> <span class="o">+</span><span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if REGION_KICK
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TRIGGER_INSTANT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">SensorHistoryTrigger</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">30</span><span class="o">&gt;</span> <span class="n">triggers</span><span class="p">[</span><span class="n">N_SENSORS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if REGION_TOP
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TRIGGER_CONT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">SensorContinuousTrigger</span><span class="o">&lt;</span><span class="mi">80</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">triggers</span><span class="p">[</span><span class="n">N_SENSORS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if REGION_FLUFF
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if REGION_SQUEEZE
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TRIGGER_CONT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">SensorContinuousTrigger</span><span class="o">&lt;</span><span class="mi">90</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">triggers</span><span class="p">[</span><span class="n">N_SENSORS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if REGION_PICK
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TRIGGER_CONT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">SensorContinuousTrigger</span><span class="o">&lt;</span><span class="mi">40</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="n">triggers</span><span class="p">[</span><span class="n">N_SENSORS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if REGION_SLIDE
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TRIGGER_CONT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">SensorContinuousTrigger</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">triggers</span><span class="p">[</span><span class="n">N_SENSORS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">MP3</span> <span class="n">mp3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MP3_DELAY 50
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">setMp3Volume</span><span class="p">(</span><span class="kt">int</span> <span class="n">vol</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">outside</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">last</span> <span class="o">+</span> <span class="n">MP3_DELAY</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">last</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mp3</span><span class="p">.</span><span class="n">setVolume</span><span class="p">(</span><span class="n">vol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if !PLAY_MP3
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="n">TCCR1A</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WGM10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">TCCR1B</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CS12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CS11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CS10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">TIMSK1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TOIE1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pinMode</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mp3</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if REGION_FLUFF
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">mp3</span><span class="p">.</span><span class="n">setVolume</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">delay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mp3</span><span class="p">.</span><span class="n">play</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">delay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mp3</span><span class="p">.</span><span class="n">playLoop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">delay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">mp3</span><span class="p">.</span><span class="n">setVolume</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">delay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mp3</span><span class="p">.</span><span class="n">noLoop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">delay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">populateCalibration</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">lastBaseInc</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ISR</span><span class="p">(</span><span class="n">TIMER1_OVF_vect</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="kt">int</span> <span class="n">timerCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pinStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">timerCount</span> <span class="o">=</span> <span class="p">((</span><span class="n">timerCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">32767</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">digitalWrite</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="p">(</span><span class="n">pinStatus</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">fadeOut</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">outside</span><span class="p">(</span><span class="n">lastBaseInc</span><span class="p">,</span> <span class="n">lastBaseInc</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">millis</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lastBaseInc</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">result</span><span class="p">[</span><span class="n">N_SENSORS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sampleCalibrated</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">FungiCapSensor</span><span class="o">::</span><span class="n">SENSOR_TIMEOUT</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#if defined(TRIGGER_INSTANT) || defined(TRIGGER_CONT)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="n">triggers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shift</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#if !PLAY_MP3
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">change</span> <span class="o">==</span> <span class="o">+</span><span class="mi">1</span> <span class="o">?</span> <span class="s">&#34;Onset   &#34;</span> <span class="o">:</span> <span class="s">&#34;Release &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34; @ &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">millis</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">==</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">fadeOut</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">setMp3Volume</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">delay</span><span class="p">(</span><span class="n">MP3_DELAY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cp">#if REGION_TOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>          <span class="n">mp3</span><span class="p">.</span><span class="n">play</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>          <span class="n">mp3</span><span class="p">.</span><span class="n">play</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="cp">#if REGION_PICK || REGION_SLIDE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">fadeOut</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">fadeOut</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cp">#if REGION_FLUFF
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">long</span> <span class="n">resultTotalMax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">resultTotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">resultTotal</span> <span class="o">+=</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">resultTotalMax</span> <span class="o">&lt;</span> <span class="n">resultTotal</span> <span class="o">&amp;&amp;</span> <span class="n">resultTotalMax</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">resultTotalMax</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resultTotalMax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">resultTotalMax</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">vol</span> <span class="o">=</span> <span class="p">(</span><span class="n">resultTotalMax</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>  <span class="c1">// 50 ~ 143 correspond to 0 ~ 31
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// int vol = (resultTotalMax - 15) / 2;  // 15 ~ 77 correspond to 0 ~ 31
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">vol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="n">vol</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">setMp3Volume</span><span class="p">(</span><span class="n">vol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// char s[64];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sprintf(s, &#34;\t0\t300\t%5ld\t%5ld\t%d&#34;, resultTotal, resultTotalMax, vol);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Serial.println(s);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cp">#elif REGION_PICK || REGION_SLIDE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">fadeOut</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">setMp3Volume</span><span class="p">(</span><span class="n">fadeOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fadeOut</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if (fadeOut &lt; 0) mp3.stop();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if !PLAY_MP3 &amp;&amp; INSPECT_SENSORS
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">static</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// if (++count == 16) count = 0; else return;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="n">N_SENSORS</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sprintf</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&#34;%6ld</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">|</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sprintf</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&#34;%6ld</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">}</span>
</span></span>
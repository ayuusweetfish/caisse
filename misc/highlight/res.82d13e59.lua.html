<span class="line"><span class="cl"><span class="kd">local</span> <span class="n">SAMPLE_RATE</span> <span class="o">=</span> <span class="mi">4000</span>
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">SAMPLE_DUR</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">SAMPLE_RATE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tables.stringsTable</span> <span class="o">=</span> <span class="kr">function</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">Length</span> <span class="o">=</span> <span class="mf">1.5</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">N</span> <span class="o">=</span> <span class="n">math.floor</span><span class="p">(</span><span class="n">Length</span> <span class="o">*</span> <span class="n">SAMPLE_RATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="kr">function</span> <span class="nf">tone</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">F1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAMPLE_DUR</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="n">F1</span> <span class="o">*</span> <span class="n">t</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">Y</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- Sawtooth + sine</span>
</span></span><span class="line"><span class="cl">    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">math.floor</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">math.sin</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">math.pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- Attack, release, vibrato</span>
</span></span><span class="line"><span class="cl">    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.20</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">/</span> <span class="mf">0.20</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">*</span> <span class="p">(</span><span class="n">Length</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.20</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Length</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.20</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">math.sin</span><span class="p">(</span><span class="n">t</span> <span class="o">/</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">math.pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">Y</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span><span class="p">,</span> <span class="n">Y3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">Y</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="n">tone</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">220</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="n">tone</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">440</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="n">tone</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">660</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="n">Y1</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="n">Y2</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">+</span> <span class="n">Y3</span> <span class="o">*</span> <span class="mf">0.04</span>
</span></span><span class="line"><span class="cl">    <span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span><span class="p">,</span> <span class="n">Y3</span> <span class="o">=</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">/</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tables.kickTable</span> <span class="o">=</span> <span class="kr">function</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cm">--[[
</span></span></span><span class="line"><span class="cl"><span class="cm">  -- Chirp
</span></span></span><span class="line"><span class="cl"><span class="cm">  local F0 = 150
</span></span></span><span class="line"><span class="cl"><span class="cm">  local K = 0.1
</span></span></span><span class="line"><span class="cl"><span class="cm">  for i = 1, 400 do
</span></span></span><span class="line"><span class="cl"><span class="cm">    local t = i * SAMPLE_DUR
</span></span></span><span class="line"><span class="cl"><span class="cm">    a[i] = math.sin(2 * math.pi * F0 * ((K^t - 1) / math.log(K)))
</span></span></span><span class="line"><span class="cl"><span class="cm">      * ((400 - i) / 400)
</span></span></span><span class="line"><span class="cl"><span class="cm">  end
</span></span></span><span class="line"><span class="cl"><span class="cm">]]</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- Fine-grained control over chirp</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">Length</span> <span class="o">=</span> <span class="mf">0.07</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">N</span> <span class="o">=</span> <span class="n">math.floor</span><span class="p">(</span><span class="n">Length</span> <span class="o">*</span> <span class="n">SAMPLE_RATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">F1</span> <span class="o">=</span> <span class="mi">1200</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAMPLE_DUR</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">F</span> <span class="o">=</span> <span class="n">F1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="n">Length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">+</span> <span class="p">(</span><span class="n">SAMPLE_DUR</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- a[i] = math.abs(phase - math.floor(phase) - 0.5) * 4 - 1 -- Triangle</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="n">math.floor</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="mi">1</span>          <span class="c1">-- Square</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">Length</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">Length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kr">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="n">v</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">values</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="n">math.max</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">math.min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">math.floor</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">32767.5</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="n">results</span><span class="p">[</span><span class="o">#</span><span class="n">results</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">v</span> <span class="o">=</span> <span class="s1">&#39;const PROGMEM int16_t &#39;</span> <span class="o">..</span> <span class="n">k</span> <span class="o">..</span> <span class="s1">&#39;[] = {&#39;</span> <span class="o">..</span> <span class="n">table.concat</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">..</span> <span class="s1">&#39;};&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="n">table.sort</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="kr">function</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="kr">return</span> <span class="n">a.k</span> <span class="o">&lt;</span> <span class="n">b.k</span> <span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">results</span> <span class="kr">do</span> <span class="n">print</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v</span><span class="p">)</span> <span class="kr">end</span>
</span></span>